name: Cloudify GitOps Demo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted, macOS]

    steps:
      - uses: actions/checkout@v4

      - name: Use local Python + venv
        shell: bash
        run: |
          python3 --version
          python3 -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Deploy to Cloudify
        shell: bash
        env:
          CFY_MANAGER_URL: ${{ secrets.CFY_MANAGER_URL }}
          CFY_USERNAME: ${{ secrets.CFY_USERNAME }}
          CFY_PASSWORD: ${{ secrets.CFY_PASSWORD }}
          CFY_TENANT: ${{ secrets.CFY_TENANT }}
          CFY_API_VERSION: v3.1
          CFY_INSECURE: "false"
        run: |
          source .venv/bin/activate
          python3 scripts/cloudify_deploy.py \
            --blueprint-id hello-bp \
            --blueprint-dir blueprints/hello \
            --application-file blueprint.yaml \
            --deployment-id hello-dev \
            --inputs-file inputs/dev.yaml \
            --workflow install \
            --wait
